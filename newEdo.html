

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="newEdo.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

<main class="main-container">
    <header class="sheet-header">
        <div class="newedo-logo-svg"></div>
    </header>

    <section id="character-details" class="character-details-container">
        <div class="legend-wounds-container">
            <div>
                <div class="character-name-container bg-brown border-thin mb-1">
                    <div>
                        <h5>Character Name:</h5>
                        <input id="characterName" type="text" class="w-100" name="attr_character_name" placeholder="Character Name" type="text">  
                    </div>
                    <div>
                        <h5>Character Lineage and Culture:</h5>
                        <input id="characterLineageCulture" type="text" class="w-100" name="attr_lineage_and_culture" placeholder="Character Lineage and Culture" type="text">
                    </div>
                    <div>
                        <h5>Character Faction and Path:</h5>
                        <input id="characterFactionPath" type="text" class="w-100" name="attr_faction_and_path" placeholder="Character Faction And Path" type="text">
                    </div>
                </div>

                
                <div class="xp-wounds-container bg-lpink border-thin">

                    <div id="legend-section" class="legend-section-container mb-1">
                        <div class="generic-content-column">
                            XP: 
                            <input type="text" class="w-100" name="attr_xp" placeholder="XP" type="text">

                            Path Rank: 
                            <input type="text" class="w-100 legend-section-input" name="attr_path_rank" placeholder="Path Rank">    

                            Size: 
                            <input id="size" type="text" class="w-100 legend-section-input" name="attr_size">  
                        </div>
                        <div class="legend-values-container">

                            Permanent Legend: 
                            <input type="text" class="w-100 legend-section-input" name="attr_legend_permanent" placeholder="Legend" type="text">

                            Temporary Legend: 
                            <input type="text" class="w-100 legend-section-input" name="attr_legend_temp" placeholder="Temporary Legend" type="text">

                            <div></div>
        
                        </div>
                        <div class="generic-content-column">
                            Max HP: <input type="text" class="w-100 legend-section-input" name="attr_max_hp" placeholder="Max HP" type="text">


                            HP Multiplier: <input id="hp_multiplier" type="text" class="w-100 legend-section-input" name="attr_hp_multiplier" placeholder="HP Multiplier" type="text">


                            Current HP: <input type="text" class="w-100 legend-section-input" name="attr_hp_current" placeholder="Current HP" type="text">
        
                        </div>

                    </div>

                    <div id="soak-wounds-section" class="soak-wounds-section-container">

                        <div>
                            <h5 class="text-center m-0">Soak</h5>

                            Kinetic: <input type="text" class="w-100 " name="attr_soak_kinetic" placeholder="Kinetic Soak">
                            Elemental: <input type="text" class="w-100 " name="attr_soak_elemental" placeholder="Elemental Soak">
                            Biological: <input type="text" class="w-100 " name="attr_soak_biological" placeholder="Biological Soak">
                            Arcane: <input type="text" class="w-100 " name="attr_soak_arcane" placeholder="Arcane Soak">
                            Cash: <input type="text" class="w-100" name="attr_cash" placeholder="Â¥" type="text">
                        </div>  

                        <div>
                            <h5 class="text-center m-0">Wounds</h5>

                            Grazed: <input type="text" class="w-100 " name="attr_grazed">
                            Flesh Wound: <input type="text" class="w-100 " name="attr_flesh_wound">
                            Banged Up: <input type="text" class="w-100 " name="attr_banged_up">
                            Hurt Bad: <input type="text" class="w-100 " name="attr_hurt_bad">
                            Burning Legend: <input type="text" class="w-100" name="attr_burning_legend" value="0">
                        </div> 

                    </div>

                    <div id="status-effects-section" class="">
                        <div>
                            Active Status Effects: 
                        </div>
                        <textarea class="conditions-textarea" name="attr_active_status_effects" placeholder="Status Effects" 
                            type="text" style="max-width: 97.5%; min-width: 97.5%;"></textarea>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="stats-container bg-grey border-thin">
            <div>
                <div class="root-stats-container">
                    <div class="generic-content-column">
                        <div>
                            <h5>Power:</h5>
                            <span class="roll-button-container">
                                <input id="power" type="text" class="w-75" name="attr_power" placeholder="10" value="10">  
                                <button id="roll_power" name="act_roll_power" type="action" class="m-0 roll-button" ><span style="font-family:dicefontd20;">t</span></button>
                            </span>

                                
                            </button>
                        </div>
                        <div>
                            <h5>Reflex:</h5>
                            <span class="roll-button-container">
                                <input id="reflex" type="text" class="w-75" name="attr_reflex" placeholder="10" value="10">
                                <button id="roll_reflex" name="act_roll_reflex" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>

                    </div>  
                    <div class="generic-content-column">
                        <div>
                            <h5>Heart:</h5>
                            <span class="roll-button-container">
                                <input id="heart" type="text" class="w-75" name="attr_heart" placeholder="10" value="10">
                                <button id="roll_heart" name="act_roll_heart" type="action" class="m-0 roll-button">  <span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>
                        <div>
                            <h5>Savvy:</h5>
                            <span class="roll-button-container">
                                <input id="savvy" type="text" class="w-75" name="attr_savvy" placeholder="10" value="10">
                                <button id="roll_savvy" name="act_roll_savvy" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>

                    </div>   
                    <div class="generic-content-column">
                        <div>
                            <h5>Presence:</h5>
                            <span class="roll-button-container">
                                <input id="presence" type="text" class="w-75" name="attr_presence" placeholder="10" value="10"> 
                                <button id="roll_presence" name="act_roll_presence" type="action" class="m-0 roll-button">   <span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>
                        <div>
                            <h5>Perception:</h5>
                            <span class="roll-button-container">
                                <input id="perception" type="text" class="w-75" name="attr_perception" placeholder="0" >
                                <button id="roll_perception" name="act_roll_perception" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>
                        <div>
                            <h5>Shinpi:</h5>
                            <span class="roll-button-container">
                                <input id="shinpi" type="text" class="w-75" name="attr_shinpi" placeholder="0" >
                                <button id="roll_shinpi" name="act_roll_shinpi" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </span>
                        </div>

                    </div>  
                </div>

        <h5 class="w-100" style="text-align: center;">
            Derived Traits 
        </h5>

        <div id="derived-traits" class="derived-traits-container">
                        

            <div class="generic-content-column">

                <span>Resolve (base): </span>
                
                <input type="text" class="w-100 legend-section-input" name="attr_resolve_base">

                <span>Resolve: </span>
                
                <input type="text" class="w-100 legend-section-input" name="attr_resolve">

            </div>
            <div class="generic-content-column">

                <span>Move (base): </span>
                
                <input type="text" class="w-100 legend-section-input" name="attr_move_base">

                <span>Move:</span>
                
                <input type="text" class="w-100 legend-section-input" name="attr_move">

            </div>
            <div class="generic-content-column">

                <span>Initiative (base):</span> 
                
                <input type="text" class="w-100 legend-section-input" name="attr_initiative_base">

                <span>Initiative:</span>

                <div class="initiative-roller">

                    <input type="text" class="w-100" name="attr_initiative"> 

                        <button id="roll_initiative" name="act_roll_initiative" type="action" class="m-0 roll-button">  <span style="font-family:dicefontd20;">t</span></button>

                </div>



            </div>
            <div class="generic-content-column">

                Defence (base): <input type="text" class="w-100 legend-section-input" name="attr_defence_base">

                Defence: <input type="text" class="w-100 legend-section-input" name="attr_defence">

            </div>

        </div>

        <div>
            <div>
                Lineage & Path Bonuses, Augs, Rotes, Skills, Abilities, Etc.
            </div>

            <textarea class="conditions-textarea" style="max-width: 97.5%; min-width: 97.5%;" name="attr_bonuses"></textarea>
        </div>

        <div>
                    <h5 class="w-100" style="text-align: center;">
            Action Economy 
        </h5>
        <div id="fav_action_uses" class="three-column">
            <div class="column-3">
            
                <div class="w-100" style="text-align: center;">
                    Move Action:
                </div>
                <input type="text" class="w-100 legend-section-input" placeholder="# of Attacks" name="attr_move_action_attack_count">
                <br>

                Favorite Actions: 
                <input type="text" class="w-100 mb-2px" name="attr_move_action_favorites1">
                <input type="text" class="w-100 mb-2px" name="attr_move_action_favorites2" >
                <input type="text" class="w-100 mb-2px" name="attr_move_action_favorites3">

            </div>
            <div class="column-3">

                <div class="w-100" style="text-align: center;">
                    Quick Action:
                </div>
                <input type="text" class="w-100 legend-section-input" placeholder="# of Attacks" name="attr_quick_action_attack_count">

                Favorite Actions: 
                <input type="text" class="w-100 mb-2px" name="attr_quick_action_favorites1" >
                <input type="text" class="w-100 mb-2px" name="attr_quick_action_favorites2">
                <input type="text" class="w-100 mb-2px" name="attr_quick_action_favorites3" >


            </div>
            <div class="column-3">

                <div class="w-100" style="text-align: center;">
                    Full Action:
                </div>
                <input type="text" class="w-100 legend-section-input" placeholder="# of Attacks" name="attr_full_action_attack_count">

                Favorite Actions: 
                <input type="text" class="w-100 mb-2px" name="attr_full_action_favorites1">
                <input type="text" class="w-100 mb-2px" name="attr_full_action_favorites2">
                <input type="text" class="w-100 mb-2px" name="attr_full_action_favorites3" >

            </div>
        </div>
        </div>
        </div>

    </section>

    <section id="fate-card">

        <div class="border-thin bg-black fate-card-container">
            <div class="fate-card-header-container">
                <div class="generic-roller">
                    <button id="roll_fate" name="act_roll_fate" type="action" title="Roll Fate" class="m-0 roll-button-grid" ><span style="font-family:dicefontd20;">t</span></button>
                </div>
                <div>
                    <h3 class="no-underline">Fate Card</span>  
                </div>
                <div class="hider-holder">
                    <input type="checkbox" class="fate-hider" name="attr_fate_hidden"> 
                </div>
            </div>

            <input type="checkbox" class="fate-hider" name="attr_fate_hidden" hidden> 
            <div id="fate-card-contents" class="fate-card-contents-container can-hide">

                <div class="fate-card-fate-line-container" style="font-size:12px; height: 20px !important;">
                    <h5 class="w-5">Min</h5>
                    <h5 class="w-5">Max</h5>
                    <h5 class="w-85">Description</h5>
                    <h5 class="w-5"></h5>
                </div>

                <fieldset class="repeating_fate-lines" style="display: none;">

                    <div class="fate-card-fate-line-container" style="font-size:12px;">
                        <div class="w-5">
                            <input type="text" class="" placeholder="min" name="attr_minpercent"> 
                        </div>
                        <div class="w-5">
                            <input type="text" class="" placeholder="max" name="attr_maxpercent"> 
                        </div>

                        <textarea type="text" class="w-90 lockwidth-fate-textarea" style="height: 18px;" placeholder="" name="attr_desc"></textarea>

                    </div>
                </fieldset>
                
            </div>
    
        </div> 

    </section>
    
    <section id="equipment-card">
        <div class="border-thin bg-blue equipment-card-container">
            <div class="equipment-card-header-container">
                <div>
                    
                </div>
                <div>
                    <h3 class="no-underline">Equipment</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>
            <input type="checkbox" class="equipment-hider" name="attr_equipment_hidden" hidden> 

                <fieldset class="repeating_equipment-lines" style="display: none;">

                    <div class="equipment-card-equipment-line-container bg-ltblue border-thin mb-1" style="font-size:12px;">

                        <div class="equipment-card-equipment-line-container-header">
                            <div class="generic-roller">
                                <button id="roll_wep" name="act_roll-wep" type="action" class="m-0 roll-button-grid" ><span style="font-family:dicefontd20;">t</span></button>
                            </div>
                            <div>
                                <span class="header-4"><input class="w-100" type="text" name="attr_wep_name" style="text-align: center;" readonly></span>  
                            </div>
                            <div class="hider-holder">
                                <input type="checkbox" class="equipment-hider" name="attr_equipment_hidden"> 
                            </div>
                        </div>
                        <input type="checkbox" class="equipment-line-hider" name="attr_equipment_hidden" hidden> 
                        <div class="equipment-card-equipment-line-contents-body can-hide">
                            <div class="equipment-card-equipment-line-details">
                                <div class="pl-2px">
                                    Name
                                </div>
                                <div class="pl-2px">
                                    Skill
                                </div>
                                <div class="pl-2px">
                                    Quality
                                </div>
                                <div class="pl-2px">
                                    Grit
                                </div>
                                <div class="pl-2px">
                                    Tier
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_name">
                                </div>
                                <div>                                
                                    <select name="attr_wep_skill_name" id="wep_skill_name" class="w-100" style="margin-bottom: 0px;">
                                        <option value="archery">Archery</option>
                                        <option value="arcana">Arcana</option>
                                        <option value="athletics">Athletics</option>
                                        <option value="banter">Banter</option>
                                        <option value="commerce">Commerce</option>
                                        <option value="computers">Computers</option>
                                        <option value="crafting">Crafting</option>
                                        <option value="deception">Deception</option>
                                        <option value="drive">Drive</option>
                                        <option value="dodge">Dodge</option>
                                        <option value="eloquence">Eloquence</option>
                                        <option value="gambling">Gambling</option>
                                        <option value="gunnery">Gunnery</option>
                                        <option value="hardware">Hardware</option>
                                        <option value="heavy_melee">Heavy Melee</option>
                                        <option value="intimidation">Intimidation</option>
                                        <option value="intuition">Intuition</option>
                                        <option value="investigation">Investigation</option>
                                        <option value="light_melee">Light Melee</option>
                                        <option value="medicine">Medicine</option>
                                        <option value="meditation">Meditation</option>
                                        <option value="performance">Performance</option>
                                        <option value="rally">Rally</option>
                                        <option value="security">Security</option>
                                        <option value="seduction">Seduction</option>
                                        <option value="sleight_of_hand">Sleight of Hand</option>
                                        <option value="small_arms">Small Arms</option>
                                        <option value="stealth">Stealth</option>
                                        <option value="streetwise">Streetwise</option>
                                        <option value="study">Study</option>
                                        <option value="surveillance">Surveillance</option>
                                        <option value="survival">Survival</option>
                                        <option value="tactics">Tactics</option>
                                        <option value="toxicology">Toxicology</option>
                                        <option value="thrown">Thrown</option>
                                        <option value="unarmed">Unarmed</option>
                                        <option value="wetware">Wetware</option>
                                        <option value="" selected="selected">-</option>
                                    </select>
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_quality">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_grit">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_tier">
                                </div>

                            </div>
                            <div class="equipment-card-equipment-line-stats">
                                <div class="pl-2px">
                                    Short/Melee
                                </div>
                                <div>
                                    Long/Thrown
                                </div>
                                <div class="pl-2px">
                                    Damage
                                </div>
                                <div class="pl-2px">
                                    Attack Bonus
                                </div>
                                <div class="pl-2px">
                                    Ammo Carried
                                </div>
                                <div class="pl-2px">
                                    Mag Size
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_short_range">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_long_range">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_damage" placeholder="Damage">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_attack_bonus">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_ammo">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_mag_size">
                                </div>
                            </div>
                            <div class="equipment-card-equipment-line-stats">
                                <div class="pl-2px">
                                    Short Mod
                                </div>
                                <div class="pl-2px">
                                    Long Mod
                                </div>
                                <div class="pl-2px">
                                    Damage Type
                                </div>
                                <div class="pl-2px">
                                    Damage Bonus
                                </div>
                                <div class="pl-2px">
                                    Burst Ammo
                                </div>
                                <div>

                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_short_modifier" placeholder="X">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_long_modifier" placeholder="X">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_damage_type" placeholder="Type">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_damage_bonus">
                                </div>
                                <div>
                                    <input class="w-100" type="text" name="attr_wep_burst_ammo">
                                </div>
                                <div>
                                </div>
                            </div>
                            <div>
                                <div class="pl-2px">
                                    Weapon Skill Unlocks, features, upgrades and notes
                                </div>
                                <textarea type="text" class="w-98 lockwidth-equipment-textarea" style="height: 18px;" placeholder="" name="attr_wep_details"></textarea>
                            </div>
                            <div style="text-align: center;">
                                Filled Mod Slots 
                                <input type="checkbox" name="attr_wep_mod_slot1">
                                <input type="checkbox" name="attr_wep_mod_slot2">
                                <input type="checkbox" name="attr_wep_mod_slot3">
                                <input type="checkbox" name="attr_wep_mod_slot4">
                                <input type="checkbox" name="attr_wep_mod_slot5">
                            </div>
                        </div>

                    </div>
                </fieldset>

            </div>
        </div>
    </section>

    <section id="armor-section">
        <div class="border-thin bg-blue armor-card-container">
            <div class="armor-card-header-container">
                <div>
                    
                </div>
                <div>
                    <h3 class="no-underline">Armor</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>
            <fieldset class="repeating_armor-lines" style="display: none;">

                    <div class="armor-card-armor-line-container bg-ltblue border-thin mb-1" style="font-size:12px;">

                        <div class="armor-card-armor-line-container-header">
                            <div class="generic-roller">
                                
                            </div>
                            <div>
                                <span class="header-4"><input class="w-100" type="text" name="attr_armor_name" style="text-align: center;" readonly></span>  
                            </div>
                            <div class="hider-holder">
                                <input type="checkbox" class="armor-hider" name="attr_armor_hidden"> 
                            </div>
                        </div>
                        <input type="checkbox" class="armor-line-hider" name="attr_armor_hidden" hidden> 
                        <div class="armor-card-armor-line-contents-body can-hide">
                            <div class="pl-2px">
                                Name
                            </div>
                            <div class="pl-2px">
                                Quality
                            </div>
                            <div class="pl-2px">
                                Soak Type(s) & Rating
                            </div>
                            <div>
                                <input class="w-100" type="text" name="attr_armor_name" placeholder="">
                            </div>
                            <div>
                                <input class="w-100" type="text" name="attr_armor_quality" placeholder="">
                            </div>
                            <div>
                                <textarea type="text" class="w-98 lockwidth-armor-textarea" style="height: 18px;" placeholder="" name="attr_armor_soakTypeRating"></textarea>
                            </div>

                        </div>

                        <div class="armor-card-armor-line-details-body can-hide" style="padding-right: 4px;">
                            <div class="pl-2px">
                                Unlocks, Features, Upgrades and Notes
                            </div>
                            <textarea type="text" class="w-98 lockwidth-armor-details-textarea" style="height: 18px;" placeholder="" name="attr_armor_details"></textarea>
                            <div style="text-align: center;">
                                Filled Mod Slots 
                                <input type="checkbox" name="attr_armor_mod_slot1">
                                <input type="checkbox" name="attr_armor_mod_slot2">
                                <input type="checkbox" name="attr_armor_mod_slot3">
                                <input type="checkbox" name="attr_armor_mod_slot4">
                                <input type="checkbox" name="attr_armor_mod_slot5">
                            </div>
                        </div>


                    </div>
                </fieldset>
        </div>
    </section>

    <section id="augs-section">
        <div class="border-thin bg-cyan augments-card-container">
            <div class="augments-card-header-container">
                <div>
                    
                </div>
                <div>
                    <h3 class="no-underline">Augs</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>
            <fieldset class="repeating_augment-lines" style="display: none;">

                    <div class="augments-card-augments-line-container bg-ltcyan border-thin mb-1" style="font-size:12px;">

                        <div class="augments-card-augments-line-container-header">
                            <div class="generic-roller">
                                
                            </div>
                            <div>
                                <span class="header-4"><input class="w-100" type="text" name="attr_aug_name" style="text-align: center;" readonly></span>  
                            </div>
                            <div class="hider-holder">
                                <input type="checkbox" class="augments-hider" name="attr_augment_hidden"> 
                            </div>
                        </div>
                        <input type="checkbox" class="augments-line-hider" name="attr_augment_hidden" hidden> 
                        <div class="augments-card-augments-line-contents-body can-hide">
                            <div class="pl-2px">
                                Name
                            </div>
                            <div class="pl-2px">
                                Rank
                            </div>
                            <div class="pl-2px">
                                Details
                            </div>
                            <div>
                                <input class="w-100" type="text" name="attr_aug_name" placeholder="">
                            </div>
                            <div>
                                <input class="w-100" type="text" name="attr_aug_rank" placeholder="">
                            </div>
                            <div>
                                <textarea type="text" class="w-98 lockwidth-augments-textarea" style="height: 18px;" placeholder="" name="attr_aug_details"></textarea>
                            </div>

                        </div>

                    </div>
                </fieldset>
        </div>
    </section>

    <section id="skills-section">
        <div class="border-thin bg-green skills-card-container">
            <div class="skills-card-header-container">
                <div>

                </div>
                <div>
                    <h3 class="no-underline">Skills</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>

            <fieldset class="repeating_skills-lines" style="display: none;">
                                <div class="skills-card-skills-line-container bg-ltgreen border-thin mb-1" style="font-size:12px;">
                    <div class="skills-card-skills-line-container-header">
                        <div class="generic-roller">
                            <button id="roll_skill" name="act_roll-skill" type="action" class="m-0 roll-button-grid" ><span style="font-family:dicefontd20;">t</span></button>
                        </div>
                        <div>
                            <span class="header-4"><input class="w-100" type="text" name="attr_skill_name" style="text-align: center;" readonly></span>  
                        </div>
                        <div class="hider-holder">
                            <input type="checkbox" class="skills-hider" name="attr_skill_hidden"> 
                        </div>
                    </div>
                    <input type="checkbox" class="skills-line-hider" name="attr_skill_hidden" hidden> 
                    <div class="skills-card-skills-line-contents-body can-hide">
                        <div class="skills-card-skills-line-contents-stats">
                            <select name="attr_skill_name" id="skill_name" class="w-100" style="margin-bottom: 0px;">
                                <option value="Archery">Archery</option>
                                <option value="Arcana">Arcana</option>
                                <option value="Athletics">Athletics</option>
                                <option value="Banter">Banter</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Computers">Computers</option>
                                <option value="Crafting">Crafting</option>
                                <option value="Deception">Deception</option>
                                <option value="Drive">Drive</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Eloquence">Eloquence</option>
                                <option value="Gambling">Gambling</option>
                                <option value="Gunnery">Gunnery</option>
                                <option value="Hardware">Hardware</option>
                                <option value="Heavy_melee">Heavy Melee</option>
                                <option value="Intimidation">Intimidation</option>
                                <option value="Intuition">Intuition</option>
                                <option value="Investigation">Investigation</option>
                                <option value="Light_melee">Light Melee</option>
                                <option value="Medicine">Medicine</option>
                                <option value="Meditation">Meditation</option>
                                <option value="Performance">Performance</option>
                                <option value="Rally">Rally</option>
                                <option value="Security">Security</option>
                                <option value="Seduction">Seduction</option>
                                <option value="Sleight of Hand">Sleight of Hand</option>
                                <option value="Small_arms">Small Arms</option>
                                <option value="Stealth">Stealth</option>
                                <option value="Streetwise">Streetwise</option>
                                <option value="Study">Study</option>
                                <option value="Surveillance">Surveillance</option>
                                <option value="Survival">Survival</option>
                                <option value="Tactics">Tactics</option>
                                <option value="Toxicology">Toxicology</option>
                                <option value="Thrown">Thrown</option>
                                <option value="Unarmed">Unarmed</option>
                                <option value="Wetware">Wetware</option>
                                <option value="" selected="selected">-</option>
                            </select>
                            <select class="m-0 no-select-arrow text-center" name="attr_skill_focus1">
                                <option value="" selected="selected">-</option>
                                <option value="d4">d4</option>
                                <option value="d6">d6</option>
                                <option value="d8">d8</option>
                                <option value="d12">d12</option>
                            </select>
                            <select class="m-0 no-select-arrow text-center" name="attr_skill_focus2">
                                <option value="" selected="selected">-</option>
                                <option value="d4">d4</option>
                                <option value="d6">d6</option>
                                <option value="d8">d8</option>
                                <option value="d12">d12</option>
                            </select>
                            <select class="m-0 no-select-arrow text-center" name="attr_skill_focus3">
                                <option value="" selected="selected">-</option>
                                <option value="d4">d4</option>
                                <option value="d6">d6</option>
                                <option value="d8">d8</option>
                                <option value="d12">d12</option>
                            </select>
                            <select class="m-0 m-0 no-select-arrow text-center" name="attr_skill_focus4">
                                <option value="" selected="selected">-</option>
                                <option value="d4">d4</option>
                                <option value="d6">d6</option>
                                <option value="d8">d8</option>
                                <option value="d12">d12</option>
                            </select>
                            <select class="m-0 no-select-arrow text-center" name="attr_skill_focus5">
                                <option value="" selected="selected">-</option>
                                <option value="d4">d4</option>
                                <option value="d6">d6</option>
                                <option value="d8">d8</option>
                                <option value="d12">d12</option>
                            </select>
                            <input type="text" class="text-center" placeholder="+" name="attr_skill_mod">
                            <select name="attr_skill_trait" id="skill_trait" class="w-100" style="margin-bottom: 0px;" >
                                <option value="" selected>-</option>  
                                <option value="power">Power</option>
                                <option value="reflex">Reflex</option>
                                <option value="heart">Heart</option>
                                <option value="savvy">Savvy</option>
                                <option value="perception">Perception</option>
                                <option value="presence">Presence</option>
                                <option value="shinpi">Shinpi</option>                               
                            </select> 
                        </div>
                        <div class="skills-card-skills-line-contents-details">
                            <div class="pl-2px">
                                Skill Ability Notes
                            </div>
                            <textarea type="text" class="w-98 lockwidth-skill-textarea" style="height: 18px;" placeholder="" name="attr_skill_details"></textarea>
                        </div>
                    </div>

                </div>
            </fieldset>

            <div class="skills-card-header-container">
                <div>

                </div>
                <div>
                    <h4 class="no-underline">Custom Skills</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>

            <fieldset class="repeating_custskills-lines" style="display: none;">

                    <div class="skills-card-skills-line-container bg-ltgreen border-thin mb-1" style="font-size:12px;">

                        <div class="skills-card-skills-line-container-header">
                            <div class="generic-roller">
                                <button id="roll_custskill" name="act_roll-custskill" type="action" class="m-0 roll-button-grid" ><span style="font-family:dicefontd20;">t</span></button>
                            </div>
                            <div>
                                <span class="header-4"><input class="w-100" type="text" name="attr_skill_name" style="text-align: center;" readonly></span>  
                            </div>
                            <div class="hider-holder">
                                <input type="checkbox" class="skills-hider" name="attr_skill_hidden"> 
                            </div>
                        </div>
                        <input type="checkbox" class="skills-line-hider" name="attr_skill_hidden" hidden> 
                        <div class="skills-card-skills-line-contents-body can-hide">
                            <div class="skills-card-skills-line-contents-stats">
                                <input type="text" class="w-100" name="attr_skill_name" placeholder="Custom">
                                <select class="m-0 no-select-arrow text-center" name="attr_skill_focus1">
                                    <option value="" selected="selected">-</option>
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d12">d12</option>
                                </select>
                                <select class="m-0 no-select-arrow text-center" name="attr_skill_focus2">
                                    <option value="" selected="selected">-</option>
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d12">d12</option>
                                </select>
                                <select class="m-0 no-select-arrow text-center" name="attr_skill_focus3">
                                    <option value="" selected="selected">-</option>
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d12">d12</option>
                                </select>
                                <select class="m-0 m-0 no-select-arrow text-center" name="attr_skill_focus4">
                                    <option value="" selected="selected">-</option>
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d12">d12</option>
                                </select>
                                <select class="m-0 no-select-arrow text-center" name="attr_skill_focus5">
                                    <option value="" selected="selected">-</option>
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d12">d12</option>
                                </select>
                                <input type="text" class="text-center" placeholder="+" name="attr_skill_mod">
                                <select name="attr_skill_trait" id="skill_trait" class="w-100" style="margin-bottom: 0px;" >
                                    <option value="" selected>-</option>  
                                    <option value="power">Power</option>
                                    <option value="reflex">Reflex</option>
                                    <option value="heart">Heart</option>
                                    <option value="savvy">Savvy</option>
                                    <option value="perception">Perception</option>
                                    <option value="presence">Presence</option>
                                    <option value="shinpi">Shinpi</option>                               
                                </select> 
                            </div>
                            <div class="skills-card-skills-line-contents-details">
                                <div class="pl-2px">
                                    Skill Ability Notes
                                </div>
                                <textarea type="text" class="w-98 lockwidth-skill-textarea" style="height: 18px;" placeholder="" name="attr_skill_details"></textarea>
                            </div>
                        </div>

                    </div>
            </fieldset>
        </div>
    </section>

    <section id="rotes-section">
                <div class="border-thin bg-purple rotes-card-container">
            <div class="rotes-card-header-container">
                <div>
                    
                </div>
                <div>
                    <h3 class="no-underline">Rotes</span>   
                </div>
                <div class="hider-holder">
                    
                </div>

            </div>
            <div class="rotes-card-kami-details-container">
                <div class="pl-2px">
                    Mikata Kami and bonus:
                </div>
                <div class="pl-2px">
                    Accessed Kami:
                </div>
                <div>
                    <input class="w-100" type="text" name="attr_mikata_and_bonus">   
                </div>
                <div>
                    <input class="w-100" type="text" name="attr_accessed_kami">  
                </div>
            </div>
            <fieldset class="repeating_rotes-lines" style="display: none;">

                    <div class="rotes-card-rote-line-container bg-ltpurple border-thin mb-1" style="font-size:12px;">

                        <div class="rotes-card-rotes-line-container-header">
                            <div class="generic-roller">
                                <button id="roll_rote" name="act_roll-rote" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </div>
                            <div>
                                <span class="header-4"><input class="w-100" type="text" name="attr_rote_name" style="text-align: center;" readonly></span>  
                            </div>
                            <div class="hider-holder">
                                <input type="checkbox" class="rotes-hider" name="attr_rote_hidden"> 
                            </div>
                        </div>
                        
                        <input type="checkbox" class="rotes-line-hider" name="attr_rote_hidden" hidden> 

                        <div class="rotes-card-rotes-line-contents-body can-hide">
                            <div class="rotes-card-rotes-line-contents-stats">
                                <div>Name</div>
                                <div>Action</div>
                                <div>TN</div>
                                <div>LC</div>
                                <div>Range</div>
                                <div>Duration</div>
                                <div>Casting Skill</div>

                                <input type="text" class="w-100" name="attr_rote_name">
                                <input type="text" class="w-100" name="attr_rote_action">
                                <input type="text" class="w-100" name="attr_rote_tn">
                                <input type="text" class="w-100" name="attr_rote_legend_cost">
                                <input type="text" class="w-100" name="attr_rote_range">
                                <input type="text" class="w-100" name="attr_rote_duration">
                                <select name="attr_rote_casting_skill" id="rote_casting_skill" class="w-100" style="margin-bottom: 0px;">
                                    <option value="archery">Archery</option>
                                    <option value="arcana">Arcana</option>
                                    <option value="athletics">Athletics</option>
                                    <option value="banter">Banter</option>
                                    <option value="commerce">Commerce</option>
                                    <option value="computers">Computers</option>
                                    <option value="crafting">Crafting</option>
                                    <option value="deception">Deception</option>
                                    <option value="drive">Drive</option>
                                    <option value="dodge">Dodge</option>
                                    <option value="eloquence">Eloquence</option>
                                    <option value="gambling">Gambling</option>
                                    <option value="gunnery">Gunnery</option>
                                    <option value="hardware">Hardware</option>
                                    <option value="heavy_melee">Heavy Melee</option>
                                    <option value="intimidation">Intimidation</option>
                                    <option value="intuition">Intuition</option>
                                    <option value="investigation">Investigation</option>
                                    <option value="light_melee">Light Melee</option>
                                    <option value="medicine">Medicine</option>
                                    <option value="meditation">Meditation</option>
                                    <option value="performance">Performance</option>
                                    <option value="rally">Rally</option>
                                    <option value="security">Security</option>
                                    <option value="seduction">Seduction</option>
                                    <option value="sleight_of_hand">Sleight of Hand</option>
                                    <option value="small_arms">Small Arms</option>
                                    <option value="stealth">Stealth</option>
                                    <option value="streetwise">Streetwise</option>
                                    <option value="study">Study</option>
                                    <option value="surveillance">Surveillance</option>
                                    <option value="survival">Survival</option>
                                    <option value="tactics">Tactics</option>
                                    <option value="toxicology">Toxicology</option>
                                    <option value="thrown">Thrown</option>
                                    <option value="unarmed">Unarmed</option>
                                    <option value="wetware">Wetware</option>
                                    <option value="" selected="selected">-</option>
                                </select>
                            </div>
                            <div class="rotes-card-rotes-line-contents-details">
                                <textarea type="text" class="w-98 lockwidth-skill-textarea" style="height: 18px;" placeholder="" name="attr_rote_details"></textarea>
                            </div>

                        </div>

                    </div>
                </fieldset>
        </div>
    </section>

    <section id="backgrounds-card">
        <div class="border-thin bg-orange backgrounds-card-container">
            <div class="backgrounds-card-header-container">
                <div>
                    <button id="roll_null" name="act_roll_null" type="action" class="m-0 roll-button-grid" style="opacity: 0;" disabled><span style="font-family:dicefontd20;">t</span></button>
                </div>
                <div>
                    <h3 class="no-underline">BackGrounds</span>   
                </div>
                <div class="hider-holder">
                    <input type="checkbox" class="background-hider" name="attr_backgrounds_hidden"> 
                </div>

            </div>

            <input type="checkbox" class="background-hider" name="attr_backgrounds_hidden" hidden> 

            <div id="background-card-contents" class="backgrounds-card-contents-container can-hide">
                <div id="backgrounds-content-header" class="backgrounds-card-content-header">
                    <div>
                        
                    </div>
                    <div style="margin-left: 5px;">
                        Score
                    </div>
                    <div style="margin-left: 5px;">
                        Description
                    </div>
                    <div>
                        
                    </div>
                </div>

                <div class="backgrounds-card-background-line-container">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Contacts:</strong></div>
                        <div><input class="w-100" type="text" name="attr_contacts_score"></div>
                        <div><textarea class="lockwidth-background-textarea" style="height: 18px;" type="text" name="attr_contacts_description"></textarea></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                            <div>
                                <button id="roll_contacts" name="act_roll_contacts" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>

                            </div>
                        </div>
                    </div> 
                </div>

                <div class="backgrounds-card-background-line-container">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Followers:</strong></div>
                        <div><input class="w-100" type="text" name="attr_followers_score"></div>
                        <div><textarea class="lockwidth-background-textarea" style="height: 18px;" type="text" name="attr_followers_description"></textarea></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                            <div>
                                <button id="roll_followers" name="act_roll_followers" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </div>
                        </div>
                    </div> 
                </div>

                <div class="backgrounds-card-background-line-container">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Soul:</strong></div>
                        <div><input class="w-100" type="text" name="attr_soul_score"></div>
                        <div><textarea class="lockwidth-background-textarea" style="height: 18px;" type="text" name="attr_soul_description"></textarea></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                            <div>
                                <button id="roll_soul" name="act_roll_soul" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>

                            </div>
                        </div>
                    </div> 
                </div>

                <div class="backgrounds-card-background-line-container">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Status:</strong></div>
                        <div><input class="w-100" type="text" name="attr_status_score"></div>
                        <div><textarea class="lockwidth-background-textarea" style="height: 18px;" type="text" name="attr_status_description"></textarea></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                            <div>
                                <button id="roll_status" name="act_roll_status" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>
                            </div>
                        </div>
                    </div> 
                </div>

                <div class="backgrounds-card-background-line-container">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Wealth:</strong></div>
                        <div><input class="w-100" type="text" name="attr_wealth_score"></div>
                        <div><textarea class="lockwidth-background-textarea" style="height: 18px;" type="text" name="attr_wealth_description"></textarea></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                            <div>
                                <button id="roll_wealth" name="act_roll_wealth" type="action" class="m-0 roll-button"><span style="font-family:dicefontd20;">t</span></button>

                            </div>
                        </div>
                    </div> 
                </div>

                <div class="backgrounds-card-background-line-container mb-1">
                    <div class="backgrounds-card-contents-body">
                        <div class="backgrounds-card-background-line-container-header"><strong>Cash:</strong></div>
                        <div><input type="text" class="w-100" name="attr_cash" placeholder="Â¥" type="text"></div>
                        <div></div>
                        <div class="backgrounds-card-background-line-container-button-holder">
                        </div>
                    </div> 
                </div>
            </div>

        </div>
    </section>

    <div>
        <p id="damage-footnote" style="letter-spacing:normal;">
            1. If you have burst damage, you must add notation to the damage roll you input. i.e. !2d10>8 means roll 2d10, explode on 8 or more.
        </p>
        <small style="text-align:left;">
            Feedback and contributions can be made <a style="text-decoration: underline;" href="https://github.com/tbolgercode/NewEdoRoll20Sheet">here.</a>
        </small>
    </div>
</main>

<rolltemplate class="sheet-rolltemplate-init">
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} adds Initiative:</h3>
        <div class="">
            <h4>{{initiative}}</h4>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-trait">
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} rolls {{traitName}}:</h3>
        <div class="">
            <h4>{{roll}}</h4>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-wep">
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} rolls attack with {{wepName}}:</h3>
        <div class="sheet-rolltemplate-rote-details" style="text-align: center;">
            <h4 style="margin-bottom: 0.3rem;">Attack Roll:</h4>
            <h4 style="margin-bottom: 0.3rem;">{{attackRoll}}</h4>
            <table class="w-100" style="text-align: center; width:100%;">    
                <tr style="font-size:12px;">
                    <td class="w-10" colspan="2"><h4>Damage</h4></td>
                </tr>
    
                <tr>
                    <td  colspan="2" style="padding: 5px;"><h4>{{damageRoll}}</h4></td>
                </tr>        
                <tr>
                    <td><h4>Short({{shortRange}})</h4></td>
                    <td><h4>Long({{longRange}})</h4></td>
                </tr>        
                <tr>
                    <td style="padding: 5px;"><h4>{{computed::shortDamage}}</h4></td>
                    <td style="padding: 5px;"><h4>{{computed::longDamage}}</h4></td>
                </tr>    
            </table>
            <h5>{{damageType}}</h5>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rote">                
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} rolls {{roteName}}:</h3>
        <div style="margin-bottom: 0.3rem;" class="">
            <h4>{{roll}}</h4>
        </div>
        <div class="">
            <h4 style="color: rgb(230, 230, 230)">TN: {{tn}}</h4>
        </div>
        <div class="sheet-rolltemplate-rote-details">
            <h4 style="color: white;">Effect:</h4>
            <p>
                {{roteDetails}}
            </p>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-skill">
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} rolls {{skillName}}:</h3>
        <div class="">
            <h4>{{roll}}</h4>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-fate">
    <div class="container">
        <h3 style="margin-bottom: 0.3rem; color: white;">{{characterName}} rolls Fate:</h3>
        <div class="">
            <div style="margin-bottom: 0.4rem;">
                <h4>{{roll}}</h4>
            </div>
            <div class="sheet-rolltemplate-rote-details">
                <h4 style="color: white;">Effect:</h4>
                <p style="color: #e4e4e4;">
                    {{effect}}
                </p>
            </div>

        </div>
    </div>
</rolltemplate>

<script type="text/worker">
        /**
     * New Edo Roll20 Character Sheet - Sheet Worker Scripts
     * Handles roll buttons, derived stats (HP, resolve, defence, etc.), and utility helpers.
     */

    // ---------------------------------------------------------------------------
    // CONSTANTS â attribute names used across roll and calc logic
    // ---------------------------------------------------------------------------

    /** Attributes needed for wound penalties and character name on rolls */
    const WOUND_ATTRS = ["max_hp", "hp_current", "grazed", "flesh_wound", "banged_up", "hurt_bad", "burning_legend", "character_name"];

    /**
     * Run a single trait roll (e.g. Power, Reflex). Uses trait attr, applies wounds, template:trait.
     * @param {string} traitAttr - Attribute name (e.g. "power", "reflex")
     * @param {string} traitLabel - Display name for roll output (e.g. "Power", "Reflex")
     */
    const doTraitRoll = (traitAttr, traitLabel) => {
        getAttrs([traitAttr, ...WOUND_ATTRS], (values) => {
            if (!values[traitAttr]) return;
            const val = parseInt(values[traitAttr], 10);
            if (Number.isNaN(val)) return;
            const d10s = getTraitRollD10s(val);
            let roll = `${d10s}d10!`;
            roll = applyWounds(roll, values);
            const charName = values.character_name || "";
            startRoll(`&{template:trait} {{characterName=${charName}}} {{traitName=${traitLabel}}} {{roll=[[${roll}]]}}`, (results) => {
                finishRoll(results.rollId, { roll: results.results.roll.result });
            });
        });
    };

    /**
     * Run a background roll (Contacts, Followers, Soul, Status, Wealth). Uses score attr, applies wounds, template:trait.
     * @param {string} scoreAttr - Attribute name (e.g. "contacts_score")
     * @param {string} traitLabel - Display name (e.g. "Contacts")
     */
    const doBackgroundRoll = (scoreAttr, traitLabel) => {
        getAttrs([scoreAttr, ...WOUND_ATTRS], (values) => {
            const score = parseInt(values[scoreAttr], 10) || 0;
            const numDice = getBackgroundD10s(score);
            const rollExpr = applyWounds(`${numDice}d10!`, values);
            startRoll(`&{template:trait} {{characterName=${values.character_name}}} {{roll=[[${rollExpr}]]}} {{traitName=${traitLabel}}}`, (results) => {
                finishRoll(results.rollId, { roll: results.results.roll.result });
            });
        });
    };

    // ---------------------------------------------------------------------------
    // BUTTON CLICKS â Roll20 event handlers
    // ---------------------------------------------------------------------------

    /** Initiative: roll initiative and add to tracker */
    on("clicked:roll_initiative", () => {
        getAttrs(["character_name", "initiative", "initiative_base"], (values) => {
            let initiative = values.initiative_base;
            if (parseInt(values.initiative, 10)) initiative = values.initiative;
            startRoll(`&{template:init} {{characterName=${values.character_name}}} {{initiative=[[${initiative} &{tracker}]]}}`, (results) => {
                finishRoll(results.rollId, {});
            });
        });
    });


    /** Weapon attack: build roll from weapon + linked skill, apply focus/mod/wounds, then damage modifiers */
    on("clicked:repeating_equipment-lines:roll-wep", (info) => {
        getSectionIDs("skills-lines", (skillIdArray) => {
            const wepAttrNames = buildAttackAttrDependencyNames(skillIdArray);
            getAttrs(wepAttrNames, (values) => {
                const valueMap = new Map(Object.entries(values));
                const skillName = valueMap.get("repeating_equipment-lines_wep_skill_name");
                const wepName = valueMap.get("repeating_equipment-lines_wep_name") || "Weapon";

                if (!skillName) return;

                const skillId = findSkillInValues(valueMap, skillName, skillIdArray);

                const traitName = (skillId === null || skillId === 0) ? getSkillDefault(skillName) : valueMap.get(`repeating_skills-lines_${skillId}_skill_trait`);
                const traitValue = traitName ? valueMap.get(traitName) : undefined;
                const traitValNum = parseInt(traitValue, 10) || 0;
                const traitRoll = getTraitRollD10s(traitValNum);

                const shortRange = valueMap.get("repeating_equipment-lines_wep_short_range") || "-";
                const longRange = valueMap.get("repeating_equipment-lines_wep_long_range") || "-";
                const damageType = valueMap.get("repeating_equipment-lines_wep_damage_type") || "";

                let damageRoll = valueMap.get("repeating_equipment-lines_wep_damage") || "0";
                const damageBonus = valueMap.get("repeating_equipment-lines_wep_damage_bonus");
                if (damageBonus) damageRoll = `${damageRoll} + ${damageBonus}`;

                let roll = `${traitRoll}d10!`;

                /* No matching skill in sheet: roll trait + wounds only; damage computed in finishRoll */
                if (parseInt(skillId, 10) === 0 || skillId === null) {
                    roll = applyWounds(roll, values);

                    startRoll(`&{template:wep} {{characterName=${values.character_name}}} {{attackRoll=[[${roll}]]}} {{wepName=${wepName}}} {{damageRoll=[[${damageRoll}]]}} {{shortRange=${shortRange}}} {{damageType=${damageType}}} {{longRange=${longRange}}} {{shortDamage=[[0]]}} {{longDamage=[[0]]}}`, (results) => {
                        const shortMod = parseFloat(valueMap.get("repeating_equipment-lines_wep_short_modifier")) || 1;
                        const longMod = parseFloat(valueMap.get("repeating_equipment-lines_wep_long_modifier")) || 1;
                        const calcShortDamage = Math.ceil(results.results.damageRoll.result * shortMod);
                        const calcLongDamage = Math.ceil(results.results.damageRoll.result * longMod);
                        finishRoll(results.rollId, { shortDamage: calcShortDamage, longDamage: calcLongDamage });
                    });
                    return;
                }

                for (let i = 1; i <= 5; i++) {
                    const diceToAdd = valueMap.get(`repeating_skills-lines_${skillId}_skill_focus${i}`);
                    if (diceToAdd) roll = `${roll} + ${diceToAdd}`;
                }
                const skillMod = valueMap.get(`repeating_skills-lines_${skillId}_skill_mod`);
                if (skillMod) roll = `${roll} + ${skillMod}`;
                const attackBonus = valueMap.get("repeating_equipment-lines_wep_attack_bonus");
                if (attackBonus) roll = `${roll} + ${attackBonus}`;

                roll = applyWounds(roll, values);

                startRoll(`&{template:wep} {{characterName=${values.character_name}}} {{attackRoll=[[${roll}]]}} {{wepName=${wepName}}} {{damageRoll=[[${damageRoll}]]}} {{shortRange=${shortRange}}} {{damageType=${damageType}}} {{longRange=${longRange}}} {{shortDamage=[[0]]}} {{longDamage=[[0]]}}`, (results) => {
                    const shortMod = parseFloat(valueMap.get("repeating_equipment-lines_wep_short_modifier")) || 1;
                    const longMod = parseFloat(valueMap.get("repeating_equipment-lines_wep_long_modifier")) || 1;
                    const calcShortDamage = Math.ceil(results.results.damageRoll.result * shortMod);
                    const calcLongDamage = Math.ceil(results.results.damageRoll.result * longMod);
                    finishRoll(results.rollId, { shortDamage: calcShortDamage, longDamage: calcLongDamage });
                });
            });
        });
    });

    /** Background rolls: Contacts, Followers, Soul, Status, Wealth */
    on("clicked:roll_contacts", () => doBackgroundRoll("contacts_score", "Contacts"));
    on("clicked:roll_followers", () => doBackgroundRoll("followers_score", "Followers"));
    on("clicked:roll_soul", () => doBackgroundRoll("soul_score", "Soul"));
    on("clicked:roll_status", () => doBackgroundRoll("status_score", "Status"));
    on("clicked:roll_wealth", () => doBackgroundRoll("wealth_score", "Wealth"));

    /** Fate: roll 1d100 and resolve effect from fate-lines min/max percent ranges, template:fate */
    on("clicked:roll_fate", () => {
        getSectionIDs("fate-lines", (fateLineIds) => {
            const attrs = getFateAttrArray(fateLineIds);
            getAttrs(attrs, (values) => {

                const charName = !values.character_name ? "" : values.character_name;
                const roll = Math.floor(Math.random() * 100) + 1;
                const effect = (roll >= 1 && roll <= 3) ? "BOTCH!" : getFateEffect(roll, values);

                startRoll(`&{template:fate} {{characterName=${values.character_name}}} {{roll=[[${roll}]]}} {{effect=${effect}}}`, (results) => {
                    const roll = results.results.roll.result;
                    finishRoll(results.rollId, { roll: roll });
                });
            });
        });
    });

    /** Rote: roll using Shinpi + casting skill focus/mod, template:rote */
    on("clicked:repeating_rotes-lines:roll-rote", (info) => {
        getSectionIDs("skills-lines", (skillIdArray) => {
            const roteAttrNames = buildRoteAttrDependencyNames(skillIdArray);
            getAttrs(roteAttrNames, (values) => {
                const valueMap = new Map(Object.entries(values));
                const skillName = valueMap.get("repeating_rotes-lines_rote_casting_skill");
                const roteName = valueMap.get("repeating_rotes-lines_rote_name") || "Rote";
                const roteDetails = valueMap.get("repeating_rotes-lines_rote_details") || "N/A";
                const tn = valueMap.get("repeating_rotes-lines_rote_tn");

                const skillId = findSkillInValues(valueMap, skillName, skillIdArray);
                const traitValNum = parseInt(valueMap.get("shinpi"), 10) || 0;
                const traitRoll = getTraitRollD10s(traitValNum);
                let roll = `${traitRoll}d10!`;

                if (parseInt(skillId, 10) === 0 || skillId === null) {
                    roll = applyWounds(roll, values);
                    startRoll(`&{template:rote} {{characterName=${values.character_name}}} {{roll=[[${roll}]]}} {{roteName=${roteName}}} {{tn=${tn}}} {{roteDetails=${roteDetails}}}`, (results) => {
                        finishRoll(results.rollId, { roll: results.results.roll.result });
                    });
                    return;
                }

                for (let i = 1; i <= 5; i++) {
                    const diceToAdd = valueMap.get(`repeating_skills-lines_${skillId}_skill_focus${i}`);
                    if (diceToAdd) roll = `${roll} + ${diceToAdd}`;
                }
                const skillMod = valueMap.get(`repeating_skills-lines_${skillId}_skill_mod`);
                if (skillMod) roll = `${roll} + ${skillMod}`;

                roll = applyWounds(roll, values);
                startRoll(`&{template:rote} {{characterName=${values.character_name}}} {{roll=[[${roll}]]}} {{roteName=${roteName}}} {{tn=${tn}}} {{roteDetails=${roteDetails}}}`, (results) => {
                    finishRoll(results.rollId, { roll: results.results.roll.result });
                });
            });
        });
    });

    /** Custom skill: roll from repeating_custskills-lines trait + focus/mod, template:skill */
    on("clicked:repeating_custskills-lines:roll-custskill", (info) => {
        const attrs = [
            "repeating_custskills-lines_skill_trait", "repeating_custskills-lines_skill_name",
            "repeating_custskills-lines_skill_focus1", "repeating_custskills-lines_skill_focus2", "repeating_custskills-lines_skill_focus3",
            "repeating_custskills-lines_skill_focus4", "repeating_custskills-lines_skill_focus5", "repeating_custskills-lines_skill_mod",
            ...WOUND_ATTRS, "power", "reflex", "heart", "savvy", "presence", "perception", "shinpi"
        ];
        getAttrs(attrs, (values) => {
            const valueMap = new Map(Object.entries(values));
            const traitName = valueMap.get("repeating_custskills-lines_skill_trait");
            if (!traitName) return;

            const traitValNum = parseInt(valueMap.get(traitName), 10) || 0;
            let roll = `${getTraitRollD10s(traitValNum)}d10!`;
            for (let i = 1; i <= 5; i++) {
                const d = valueMap.get(`repeating_custskills-lines_skill_focus${i}`);
                if (d) roll = `${roll} + ${d}`;
            }
            const mod = valueMap.get("repeating_custskills-lines_skill_mod");
            if (mod) roll = `${roll} + ${mod}`;
            roll = applyWounds(roll, values);

            const skillName = (valueMap.get("repeating_custskills-lines_skill_name") || "").replaceAll("_", " ");
            startRoll(`&{template:skill} {{characterName=${values.character_name}}} {{roll=[[${roll}]]}} {{skillName=${skillName}}}`, (results) => {
                finishRoll(results.rollId, { roll: results.results.roll.result });
            });
        });
    });

    /** Repeating skills: roll from repeating_skills-lines trait + focus/mod, template:skill */
    on("clicked:repeating_skills-lines:roll-skill", (info) => {
        const attrs = [
            "repeating_skills-lines_skill_trait", "repeating_skills-lines_skill_name",
            "repeating_skills-lines_skill_focus1", "repeating_skills-lines_skill_focus2", "repeating_skills-lines_skill_focus3",
            "repeating_skills-lines_skill_focus4", "repeating_skills-lines_skill_focus5", "repeating_skills-lines_skill_mod",
            ...WOUND_ATTRS, "power", "reflex", "heart", "savvy", "presence", "perception", "shinpi"
        ];
        getAttrs(attrs, (values) => {
            const valueMap = new Map(Object.entries(values));
            const traitName = valueMap.get("repeating_skills-lines_skill_trait");
            if (!traitName) return;

            const traitValNum = parseInt(valueMap.get(traitName), 10) || 0;
            let roll = `${getTraitRollD10s(traitValNum)}d10!`;
            for (let i = 1; i <= 5; i++) {
                const d = valueMap.get(`repeating_skills-lines_skill_focus${i}`);
                if (d) roll = `${roll} + ${d}`;
            }
            const mod = valueMap.get("repeating_skills-lines_skill_mod");
            if (mod) roll = `${roll} + ${mod}`;
            roll = applyWounds(roll, values);

            const skillName = (valueMap.get("repeating_skills-lines_skill_name") || "").replaceAll("_", " ");
            startRoll(`&{template:skill} {{characterName=${values.character_name}}} {{roll=[[${roll}]]}} {{skillName=${skillName}}}`, (results) => {
                finishRoll(results.rollId, { roll: results.results.roll.result });
            });
        });
    });

    /** Core trait rolls: Power, Reflex, Heart, Savvy, Presence, Perception, Shinpi */
    on("clicked:roll_power", () => doTraitRoll("power", "Power"));
    on("clicked:roll_reflex", () => doTraitRoll("reflex", "Reflex"));
    on("clicked:roll_heart", () => doTraitRoll("heart", "Heart"));
    on("clicked:roll_savvy", () => doTraitRoll("savvy", "Savvy"));
    on("clicked:roll_presence", () => doTraitRoll("presence", "Presence"));
    on("clicked:roll_perception", () => doTraitRoll("perception", "Perception"));
    on("clicked:roll_shinpi", () => doTraitRoll("shinpi", "Shinpi"));

    // ---------------------------------------------------------------------------
    // BUTTON CLICKS â END
    // ---------------------------------------------------------------------------


    // ---------------------------------------------------------------------------
    // AUTOMATIC VALUE ADJUSTMENTS â derived stats on attribute change
    // ---------------------------------------------------------------------------

    on("change:heart", () => {
        calcMaxHp();
        calcMove();
        calcResolve();
    });

    on("change:hp_multiplier", () => {
        calcMaxHp();
    });

    on("change:presence", () => {
        calcResolve();
    });

    on("change:reflex", () => {
        calcMove();
        calcDefence();
    });

    on("change:savvy", () => {
        calcInitiative();
    });

    on("change:power", () => {
        calcDefence();
    });

    // ---------------------------------------------------------------------------
    // UTIL FNS â calculations and roll helpers
    // ---------------------------------------------------------------------------

    /** Max HP and wound thresholds from Heart Ã hp_multiplier */
    const calcMaxHp = () => {
        getAttrs(["heart", "hp_multiplier"], (values) => {
            if (!values.heart || !values.hp_multiplier) return;
            const heart = parseInt(values.heart, 10);
            const hp_multiplier = parseFloat(values.hp_multiplier);
            if (Number.isNaN(heart) || Number.isNaN(hp_multiplier)) return;

            const max_hp = roundUp(heart * hp_multiplier);
            setAttrs({
                max_hp,
                grazed: Math.floor(max_hp * 0.9),
                flesh_wound: Math.floor(max_hp * 0.75),
                banged_up: Math.floor(max_hp * 0.25),
                hurt_bad: Math.floor(max_hp * 0.1)
            });
        });
    };

    /** Resolve (base) = round up (Heart + Presence) Ã 0.4 */
    const calcResolve = () => {
        getAttrs(["heart", "presence"], (values) => {
            if (!values.heart || !values.presence) return;
            const heart = parseInt(values.heart, 10);
            const presence = parseInt(values.presence, 10);
            if (Number.isNaN(heart) || Number.isNaN(presence)) return;
            setAttrs({ resolve_base: roundUp((heart + presence) * 0.4) });
        });
    };

    /** Initiative (base) = Reflex + Savvy */
    const calcInitiative = () => {
        getAttrs(["reflex", "savvy"], (values) => {
            if (!values.reflex || !values.savvy) return;
            const reflex = parseInt(values.reflex, 10);
            const savvy = parseInt(values.savvy, 10);
            if (Number.isNaN(reflex) || Number.isNaN(savvy)) return;
            setAttrs({ initiative_base: roundUp(reflex + savvy) });
        });
    };

    /** Defence (base) = round up (Reflex + Power) Ã 0.4 */
    const calcDefence = () => {
        getAttrs(["power", "reflex"], (values) => {
            if (!values.reflex || !values.power) return;
            const reflex = parseInt(values.reflex, 10);
            const power = parseInt(values.power, 10);
            if (Number.isNaN(reflex) || Number.isNaN(power)) return;
            setAttrs({ defence_base: roundUp((reflex + power) * 0.4) });
        });
    };

    /** Move (base) = round up (Reflex + Heart) / Size */
    const calcMove = () => {
        getAttrs(["reflex", "heart", "size"], (values) => {
            if (!values.heart || !values.reflex || !values.size) return;
            const reflex = parseInt(values.reflex, 10);
            const heart = parseInt(values.heart, 10);
            const size = parseInt(values.size, 10);
            if (Number.isNaN(heart) || Number.isNaN(reflex) || Number.isNaN(size)) return;
            setAttrs({ move_base: roundUp((reflex + heart) / size) });
        });
    };

    const roundUp = (n) => Math.ceil(n);

    /** Number of d10s for a trait roll from trait score (e.g. 10â1, 25â2). */
    const getTraitRollD10s = (score) => (score < 10 ? 1 : Math.floor(score / 10));


    /** Build attribute list for fate repeating section + wound attrs */
    const getFateAttrArray = (fateLineIds) => {
        const columns = [];
        for (let i = 0; i < fateLineIds.length; i++) {
            columns.push(`repeating_fate-lines_${fateLineIds[i]}_minpercent`, `repeating_fate-lines_${fateLineIds[i]}_maxpercent`, `repeating_fate-lines_${fateLineIds[i]}_desc`);
        }
        columns.push("max_hp", "hp_current", "grazed", "flesh_wound", "banged_up", "hurt_bad", "burning_legend");
        return columns;
    };

    /** Resolve fate effect text from roll value and fate line min/max ranges */
    const getFateEffect = (roll, values) => {
        const effectMap = new Map(Object.entries(values));
        const fateIds = getSectionIdsFromPrefix(effectMap, "repeating_fate-lines");
        for (let i = 0; i < fateIds.length; i++) {
            const minP = parseInt(effectMap.get(`repeating_fate-lines_${fateIds[i]}_minpercent`));
            const maxP = parseInt(effectMap.get(`repeating_fate-lines_${fateIds[i]}_maxpercent`));
            const desc = effectMap.get(`repeating_fate-lines_${fateIds[i]}_desc`);
            if (!Number.isNaN(minP) && !Number.isNaN(maxP) && desc && minP <= roll && maxP >= roll) return desc;
        }
        return "None";
    };

    const getSkillValue = (skillNum) => document.getElementById(`skill${skillNum}_trait`)?.value;

    const buildTraitMap = (values) => {
        const traits = new Map();
        traits.set("heart", values.heart);
        traits.set("power", values.power);
        traits.set("reflex", values.reflex);
        traits.set("savvy", values.savvy);
        traits.set("presence", values.presence);
        traits.set("shinpi", values.shinpi);
        traits.set("", 0);
        return traits;
    };

    /** Attribute names needed for rote roll (repeating rotes + skills + traits + wounds). */
    const buildRoteAttrDependencyNames = (skillIdArray) => {
        const skillAttrNames = [];
        for(var i=0; i < skillIdArray.length; i++) {
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_trait`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_name`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus1`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus2`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus3`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus4`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus5`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_mod`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_trait`);
        }
        skillAttrNames.push("power");
        skillAttrNames.push(`reflex`);
        skillAttrNames.push(`heart`);
        skillAttrNames.push(`savvy`);
        skillAttrNames.push(`presence`);
        skillAttrNames.push(`perception`);
        skillAttrNames.push(`shinpi`);
        skillAttrNames.push(`character_name`);
        skillAttrNames.push(`repeating_rotes-lines_rote_name`);
        skillAttrNames.push(`repeating_rotes-lines_rote_tn`);
        skillAttrNames.push(`repeating_rotes-lines_rote_casting_skill`);
        skillAttrNames.push(`repeating_rotes-lines_rote_details`);
        skillAttrNames.push("max_hp");
        skillAttrNames.push("hp_current");
        skillAttrNames.push("grazed");
        skillAttrNames.push("flesh_wound");
        skillAttrNames.push("banged_up");
        skillAttrNames.push("hurt_bad");
        skillAttrNames.push("burning_legend");

        return skillAttrNames;
    }


    /** Attribute names needed for weapon attack roll (repeating skills + equipment line + wounds). */
    const buildAttackAttrDependencyNames = (skillIdArray) => {
        const skillAttrNames = [];

        for(var i=0; i < skillIdArray.length; i++) {
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_trait`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_name`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus1`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus2`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus3`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus4`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_focus5`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_mod`);
            skillAttrNames.push(`repeating_skills-lines_${skillIdArray[i]}_skill_trait`);
        }
        skillAttrNames.push(`repeating_skills-lines_trait`);
        skillAttrNames.push("power");
        skillAttrNames.push(`reflex`);
        skillAttrNames.push(`heart`);
        skillAttrNames.push(`savvy`);
        skillAttrNames.push(`presence`);
        skillAttrNames.push(`perception`);
        skillAttrNames.push(`shinpi`);
        skillAttrNames.push(`character_name`);
        skillAttrNames.push("max_hp");
        skillAttrNames.push("hp_current");
        skillAttrNames.push("grazed");
        skillAttrNames.push("flesh_wound");
        skillAttrNames.push("banged_up");
        skillAttrNames.push("hurt_bad");
        skillAttrNames.push("burning_legend");
        skillAttrNames.push(`wep_name`);
        skillAttrNames.push(`repeating_equipment-lines_wep_skill_name`);
        skillAttrNames.push(`repeating_equipment-lines_wep_short_range`);
        skillAttrNames.push(`repeating_equipment-lines_wep_long_range`);
        skillAttrNames.push(`repeating_equipment-lines_wep_damage_type`);
        skillAttrNames.push(`repeating_equipment-lines_wep_damage`);
        skillAttrNames.push(`repeating_equipment-lines_wep_burst_roll`);
        skillAttrNames.push(`repeating_equipment-lines_wep_short_modifier`);
        skillAttrNames.push(`repeating_equipment-lines_wep_long_modifier`);
        skillAttrNames.push(`repeating_equipment-lines_wep_attack_bonus`);
        skillAttrNames.push(`repeating_equipment-lines_wep_damage_bonus`);
        skillAttrNames.push(`repeating_equipment-lines_wep_name`);
        skillAttrNames.push(`character_id`);
        skillAttrNames.push(`_reporder_repeating_skills-lines`);

        return skillAttrNames;
    }

    /** Default trait for a skill when not in repeating skills (e.g. "athletics" â "power"). */
    const getSkillDefault = (nameToFind) => {
        const map = new Map();
        map.set("crafting", "heart");
        map.set("meditation", "heart");
        map.set("rally", "heart");
        map.set("survival", "heart");
        map.set("athletics", "power");
        map.set("heavy_melee", "power");
        map.set("light_melee", "power");
        map.set("thrown", "power");
        map.set("unarmed", "power");
        map.set("banter", "reflex");
        map.set("dodge", "reflex");
        map.set("drive", "reflex");
        map.set("sleight_of_hand", "reflex");
        map.set("stealth", "reflex");
        map.set("deception", "presence");
        map.set("eloquence", "presence");
        map.set("intimidation", "presence");
        map.set("performance", "presence");
        map.set("seduction", "presence");
        map.set("archery", "perception");
        map.set("commerce", "perception");
        map.set("gunnery", "perception");
        map.set("intuition", "perception");
        map.set("investigation", "perception");
        map.set("small_arms", "perception");
        map.set("arcana", "savvy");
        map.set("computers", "savvy");
        map.set("gambling", "savvy");
        map.set("hardware", "savvy");
        map.set("medicine", "savvy");
        map.set("security", "savvy");
        map.set("streetwise", "savvy");
        map.set("study", "savvy");
        map.set("surveillance", "savvy");
        map.set("tactics", "savvy");
        map.set("toxicology", "savvy");
        map.set("wetware", "savvy");

        return map.get(nameToFind);
    }


    /** Find repeating_skills-lines row id whose skill_name matches (case-insensitive). Returns null if not found. */
    const findSkillInValues = (valueMap, nameToFind, skillIds) => {
        if (!nameToFind) return null;
        const found = skillIds.find((skillId) => {
            const name = valueMap.get(`repeating_skills-lines_${skillId}_skill_name`);
            return name && name.toLowerCase() === nameToFind.toLowerCase();
        });
        return found !== undefined ? found : null;
    };

    const getSkillLineIds = () => {

    }

    /** Wound penalty string from current HP vs thresholds (e.g. "(-3)" for flesh wound). Empty string if no penalty. */
    const getWoundDeficit = (values) => {
        const currentHp = parseInt(values.hp_current, 10);
        const maxHp = parseInt(values.max_hp, 10);
        if (Number.isNaN(currentHp) || Number.isNaN(maxHp) || currentHp >= Math.ceil(maxHp * 0.9)) return "";
        if (currentHp <= parseInt(values.burning_legend, 10)) return "(-10)";
        if (currentHp <= parseInt(values.hurt_bad, 10)) return "(-7)";
        if (currentHp <= parseInt(values.banged_up, 10)) return "(-5)";
        if (currentHp <= parseInt(values.flesh_wound, 10)) return "(-3)";
        if (currentHp <= parseInt(values.grazed, 10)) return "(-1)";
        return "";
    };

    /** Append wound penalty to roll expression if applicable */
    const applyWounds = (roll, values) => {
        const woundDeficit = getWoundDeficit(values);
        return woundDeficit ? `${roll} + ${woundDeficit}` : roll;
    };

    /** Number of d10s for a background roll from score (e.g. Contacts). */
    const getBackgroundD10s = (value) => {
        if (value <= 10) return 1;
        if (value <= 30) return 2;
        if (value <= 65) return 3;
        if (value <= 90) return 4;
        if (value <= 100) return 5;
        return 1;
    };

    const getLegendD10s = (value) => {
        if (value <= 45) return 1;
        if (value <= 75) return 2;
        if (value <= 110) return 3;
        if (value <= 160) return 4;
        return 5;
    };

    const getKeysWithPrefix = (map, prefix) => Array.from(map.keys()).filter((key) => key.startsWith(prefix));

    /** Extract unique repeating section row IDs from a map's keys (e.g. repeating_fate-lines_ABC_def â ABC). */
    const getSectionIdsFromPrefix = (map, sectionPrefix) => {
        const results = [];
        for (const key of map.keys()) {
            if (key.startsWith(sectionPrefix)) {
                const parts = key.split("_");
                if (parts.length > 2) results.push(parts[2]);
            }
        }
        return [...new Set(results)];
    };

    // ---------------------------------------------------------------------------
    // UTIL FNS â END
    // ---------------------------------------------------------------------------
</script>